<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vida Plena</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --green-dark: #285430;
            --green-light: #5F8D4E;
            --accent-color: #E5B80B;
            --text-color: #333333;
            --text-light: #555555;
            --bg-color: #FFFFFF;
            --bg-soft: #FBF8F1;
            --white: #FFFFFF;
            --border-color: #eee;
            --danger-color: #a72626;
            --warning-color: #E5B80B;
            --info-color: #0284c7; 
            --font-title: 'Poppins', sans-serif;
            --font-body: 'Lato', sans-serif;
            --shadow: 0 4px 20px rgba(0,0,0,0.07);
        }
        
        @property --p-articles{ syntax: '<number>'; inherits: true; initial-value: 0; }
        @property --p-ebooks{ syntax: '<number>'; inherits: true; initial-value: 0; }
        @property --p-topics{ syntax: '<number>'; inherits: true; initial-value: 0; }
        @property --bar-value { syntax: '<number>'; inherits: true; initial-value: 0; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-soft);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }
        
        .admin-sidebar {
            width: 260px;
            background-color: var(--bg-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: fixed;
            height: 100%;
        }
        .admin-logo {
            font-family: var(--font-title);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--green-dark);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
            padding: 10px 0;
        }
        .admin-nav {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
        }
        .admin-nav a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
            position: relative; /* Para o badge */
        }
        .admin-nav a:hover {
            background: var(--bg-soft);
            color: var(--text-color);
        }
        .admin-nav a.active {
            background: var(--green-light);
            color: white;
        }
        .admin-nav a#logout-btn {
            margin-top: auto;
            color: var(--danger-color);
        }
        .admin-nav a#logout-btn:hover {
            background-color: #f8d7da;
            color: var(--danger-color);
        }
        
        .admin-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 50%;
            padding: 2px 7px;
            display: none;
        }
        .admin-badge.visible {
            display: block;
        }

        .admin-main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            margin-left: 260px;
        }
        .admin-panel {
            display: none;
        }
        .admin-panel.active {
            display: block;
        }
        .admin-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .admin-header h1 {
            font-family: var(--font-title);
            font-size: 2.5rem;
            color: var(--green-dark);
        }
        
        .admin-search-bar {
            position: relative;
            min-width: 300px;
        }
        .admin-search-bar input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .admin-search-bar i,
        .admin-search-bar svg {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none; 
        }
        
        .admin-card {
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 30px;
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            white-space: nowrap;
        }
        .data-table th {
            font-family: var(--font-title);
            font-weight: 600;
            color: var(--text-light);
        }
        .data-table td .email {
            color: var(--text-light);
            font-size: 0.9em;
        }
        .data-table .actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.3s;
            display: inline-block;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            text-align: center;
        }
        .btn-primary { background-color: var(--green-dark); color: var(--white); }
        .btn-primary:hover { background-color: var(--green-light); }
        .btn-secondary { background: #eee; color: var(--text-color); }
        .btn-secondary:hover { background: #ddd; }
        
        .btn-icon {
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.9em;
            line-height: 1;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-icon i { width: 16px; height: 16px; vertical-align: middle; }
        .btn-edit { background-color: var(--bg-soft); color: var(--text-light); }
        .btn-edit:hover { background-color: #eee; }
        .btn-delete { background-color: #fef0f0; color: var(--danger-color); }
        .btn-delete:hover { background-color: var(--danger-color); color: var(--white); }
        
        .btn-resolve { background-color: #f0f9fe; color: var(--warning-color); }
        .btn-resolve:hover { background-color: var(--warning-color); color: var(--white); }

        .status-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .status-dot.online {
            background-color: var(--green-light);
        }
        .status-dot.offline {
            background-color: #aaa;
        }
        .status-text {
            color: var(--text-light);
            font-size: 0.9em;
        }
        .status-text.online {
            color: var(--green-dark);
            font-weight: 600;
        }

        .report-status-badge {
            padding: 4px 10px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85em;
            text-transform: uppercase;
        }
        .report-status-badge.new {
            background-color: #fef0f0;
            color: var(--danger-color);
        }
        .report-status-badge.resolved {
            background-color: #f0fdf4;
            color: var(--green-dark);
        }
        .report-reason-cell {
            white-space: normal;
            min-width: 250px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.visible {
            display: flex;
        }
        .modal-content {
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
        }
        .modal-content h2 {
            font-family: var(--font-title);
            font-size: 2rem;
            color: var(--green-dark);
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .form-group input[type="text"],
        .form-group input[type="email"] {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: var(--font-body);
            font-size: 1rem;
        }
        .form-group input[disabled] {
            background: #f0f0f0;
            cursor: not-allowed;
        }
        .form-group-check {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }
        .form-group-check input {
            width: 18px;
            height: 18px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .modal-user-content {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .modal-user-content h3 {
            font-family: var(--font-title);
            font-size: 1.2rem;
            color: var(--green-dark);
            margin-bottom: 15px;
        }
        .user-content-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-soft);
            padding: 15px;
            border-radius: 8px;
        }
        .user-content-list p {
            font-size: 0.95rem;
            color: var(--text-light);
        }
        .user-content-list-item {
            display: block;
            text-decoration: none;
            color: var(--text-color);
            font-weight: 600;
            padding: 8px;
            border-radius: 5px;
            transition:background-color 0.3s;
        }
        .user-content-list-item:hover {
            background-color: #eee;
        }
        
        /* ================================================================ */
        /* ESTILOS DO DASHBOARD (CARDS E GRÁFICO DONUT)         */
        /* ================================================================ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* [MUDANÇA] Coloquei 5 cards */
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: var(--bg-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .stat-card .icon-wrapper {
            padding: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stat-card .icon-wrapper i,
        .stat-card .icon-wrapper svg {
            width: 32px;
            height: 32px;
        }
        .stat-card .stat-info span {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: var(--font-title);
            color: var(--text-color);
            display: block;
        }
        .stat-card .stat-info p {
            font-size: 0.95rem; /* [MUDANÇA] Diminuí um pouco a fonte */
            color: var(--text-light);
            margin: 0;
            line-height: 1.3;
        }
        /* Cores dos Ícones */
        .stat-card.active-users .icon-wrapper { background-color: #e0f2fe; color: var(--info-color); }
        .stat-card.users .icon-wrapper { background-color: #e0f2fe; color: #0284c7; }
        .stat-card.articles .icon-wrapper { background-color: #e0fdf4; color: var(--green-dark); }
        .stat-card.ebooks .icon-wrapper { background-color: #fefce8; color: #ca8a04; }
        .stat-card.reports .icon-wrapper { background-color: #fef2f2; color: var(--danger-color); }

        /* Gráfico Donut (CSS) */
        .chart-container {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .donut-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            /* [MUDANÇA] Aqui está a mágica do gráfico donut animado */
            background: conic-gradient(
                var(--green-dark) 0% calc(var(--p-articles) * 1%), 
                var(--green-light) calc(var(--p-articles) * 1%) calc((var(--p-articles) + var(--p-ebooks)) * 1%),
                var(--accent-color) calc((var(--p-articles) + var(--p-ebooks)) * 1%) calc((var(--p-articles) + var(--p-ebooks) + var(--p-topics)) * 1%),
                var(--border-color) 0% /* O que sobra */
            );
            transition: --p-articles 1s, --p-ebooks 1s, --p-topics 1s;
            flex-shrink: 0;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .chart-legend {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .chart-legend li {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        .chart-legend .legend-dot {
            width: 15px;
            height: 15px;
            border-radius: 4px;
        }
        .chart-legend .legend-label {
            color: var(--text-light);
        }
        .chart-legend .legend-value {
            font-family: var(--font-title);
            color: var(--text-color);
        }
        
        /* Cores da Legenda */
        .chart-legend .dot-articles { background-color: var(--green-dark); }
        .chart-legend .dot-ebooks { background-color: var(--green-light); }
        .chart-legend .dot-topics { background-color: var(--accent-color); }

        
        /* Dark Mode for Dashboard */
        body.dark-mode .stat-card { background-color: var(--bg-color); }
        body.dark-mode .stat-card .stat-info span { color: var(--text-color); }
        body.dark-mode .stat-card .stat-info p { color: var(--text-light); }
        body.dark-mode .stat-card.active-users .icon-wrapper { background-color: #1e3a8a; color: #bfdbfe; }
        body.dark-mode .stat-card.users .icon-wrapper { background-color: #1e3a8a; color: #bfdbfe; }
        body.dark-mode .stat-card.articles .icon-wrapper { background-color: var(--green-dark); color: #a7f3d0; }
        body.dark-mode .stat-card.ebooks .icon-wrapper { background-color: #713f12; color: #fef08a; }
        body.dark-mode .stat-card.reports .icon-wrapper { background-color: #991b1b; color: #fecaca; }
        body.dark-mode .chart-legend .legend-value { color: var(--text-color); }
        body.dark-mode .donut-chart {
            background: conic-gradient(
                var(--green-dark) 0% calc(var(--p-articles) * 1%), 
                var(--green-light) calc(var(--p-articles) * 1%) calc((var(--p-articles) + var(--p-ebooks)) * 1%),
                var(--accent-color) calc((var(--p-articles) + var(--p-ebooks)) * 1%) calc((var(--p-articles) + var(--p-ebooks) + var(--p-topics)) * 1%),
                var(--border-color) 0%
            );
        }
        /* ================================================================ */
        /* FIM DOS ESTILOS DO DASHBOARD                                   */
        /* ================================================================ */
        
        /* --- Estilos Novas Métricas --- */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .metric-item {
            text-align: center;
            background: var(--bg-soft);
            padding: 20px;
            border-radius: 10px;
        }
        .metric-item i {
            width: 32px;
            height: 32px;
            color: var(--green-dark);
            margin-bottom: 10px;
        }
        .metric-item span {
            font-size: 2rem;
            font-weight: 700;
            font-family: var(--font-title);
            color: var(--text-color);
            display: block;
            line-height: 1.2;
        }
        .metric-item p {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 5px;
        }
        body.dark-mode .metric-item {
            background: var(--bg-color); /* No dark mode, o card fica mais escuro */
        }
        body.dark-mode .metric-item span {
            color: var(--text-color);
        }

        /* --- Estilos Gráfico de Barras --- */
        .bar-chart-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 25px;
        }
        .bar-chart-item {
            display: grid;
            grid-template-columns: 120px 1fr 40px;
            align-items: center;
            gap: 15px;
        }
        .bar-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-light);
            text-align: right;
        }
        .bar-wrapper {
            background-color: var(--bg-soft);
            border-radius: 6px;
            overflow: hidden;
            height: 20px;
        }
        .bar {
            height: 100%;
            width: calc(var(--bar-value) * 1%); 
            background-color: var(--green-light);
            border-radius: 6px;
            transition: width 1.5s ease-out;
        }
        #stat-bar-users { background-color: var(--info-color); }
        #stat-bar-articles { background-color: var(--green-dark); }
        #stat-bar-ebooks { background-color: var(--accent-color); }

        .bar-value {
            font-weight: 700;
            font-family: var(--font-title);
            font-size: 1.1rem;
        }
        
        /* --- Estilos do Arquivo --- */
        .archive-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
            align-items: flex-start;
        }
        .archive-menu {
            background-color: var(--bg-color);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 20px;
            position: sticky;
            top: 40px; /* Distância do topo */
        }
        .archive-menu h3 {
            font-family: var(--font-title);
            font-size: 1.5rem;
            color: var(--green-dark);
            margin-bottom: 20px;
        }
        .archive-year {
            margin-bottom: 15px;
        }
        .archive-year-header {
            font-family: var(--font-title);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .archive-year-header i {
            transition: transform 0.3s;
        }
        .archive-year.open .archive-year-header i {
            transform: rotate(90deg);
        }
        .archive-month-list {
            list-style: none;
            padding-left: 10px;
            margin-top: 10px;
            border-left: 2px solid var(--border-color);
            display: none; /* Começa fechado */
        }
        .archive-year.open .archive-month-list {
            display: block;
        }
        .archive-month-list li {
            margin-bottom: 5px;
        }
        .archive-month-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .archive-month-btn:hover {
            background-color: var(--bg-soft);
            color: var(--text-color);
        }
        .archive-month-btn.active {
            background-color: var(--green-light);
            color: var(--white);
        }
        .archive-month-btn .month-total {
            font-size: 0.8em;
            font-weight: 400;
            opacity: 0.7;
        }
        
        .archive-results .admin-card {
             box-shadow: none;
             padding: 0;
        }
        .archive-results-header {
            text-align: center;
            padding: 20px;
            background-color: var(--bg-soft);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .archive-results-header h2 {
            font-family: var(--font-title);
            font-size: 2rem;
            color: var(--green-dark);
            margin-bottom: 15px;
        }
        .archive-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        .archive-summary-item span {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-title);
            color: var(--text-color);
            display: block;
        }
        .archive-summary-item p {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .archive-daily-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .archive-daily-table th, 
        .archive-daily-table td {
            text-align: center;
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .archive-daily-table th {
            font-size: 0.9rem;
        }
        .archive-daily-table td.day-cell {
            font-weight: 700;
            font-family: var(--font-title);
            width: 60px;
        }
        .archive-daily-table td.highlight-max {
            background-color: #e0fdf4;
            color: var(--green-dark);
            font-weight: 700;
        }
        .archive-daily-table td.highlight-min {
            background-color: #fef0f0;
            color: var(--danger-color);
        }
        .archive-daily-table td.no-activity {
            color: #ccc;
        }
        
        /* Correção do erro de digitação da última vez */
        .user-content-list-item:hover {
            background-color: #eee;
        }
    </style>
</head>
<body>

    <aside class="admin-sidebar">
        <a href="index.html" class="admin-logo">
            <i data-lucide="shield"></i> Admin
        </a>
        <ul class="admin-nav">
            <li><a href="#dashboard" class="nav-tab active"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
            <li><a href="#usuarios" class="nav-tab"><i data-lucide="users"></i> Usuários</a></li>
            <li><a href="#artigos" class="nav-tab"><i data-lucide="file-text"></i> Artigos</a></li>
            <li><a href="#ebooks" class="nav-tab"><i data-lucide="book-open"></i> E-books</a></li>
            <li><a href="#forum" class="nav-tab"><i data-lucide="messages-square"></i> Tópicos do Fórum</a></li>
            
            <li>
                <a href="#denuncias" class="nav-tab">
                    <i data-lucide="alert-octagon"></i> Denúncias
                    <span id="reports-badge" class="admin-badge">0</span>
                </a>
            </li>
            
            <li>
                <a href="#arquivo" class="nav-tab">
                    <i data-lucide="archive"></i> Arquivo
                </a>
            </li>
            
            <li><a href="index.html" target="_blank"><i data-lucide="home"></i> Ver Site</a></li>
            <li><a id="logout-btn"><i data-lucide="log-out"></i> Sair</a></li>
        </ul>
    </aside>

    <main class="admin-main">
        
        <div id="dashboard-panel" class="admin-panel active">
            <div class="admin-header">
                <h1>Dashboard de Analytics</h1>
            </div>
            
            <div class="dashboard-grid">
                <div class="stat-card active-users">
                    <div class="icon-wrapper"><i data-lucide="zap"></i></div>
                    <div class="stat-info">
                        <span id="stat-active-users">...</span>
                        <p>Usuários Ativos</p>
                    </div>
                </div>
                
                <div class="stat-card users">
                    <div class="icon-wrapper"><i data-lucide="users"></i></div>
                    <div class="stat-info">
                        <span id="stat-total-users">...</span>
                        <p>Total de Usuários</p>
                    </div>
                </div>
                <div class="stat-card articles">
                    <div class="icon-wrapper"><i data-lucide="file-text"></i></div>
                    <div class="stat-info">
                        <span id="stat-total-articles">...</span>
                        <p>Total de Artigos</p>
                    </div>
                </div>
                <div class="stat-card ebooks">
                    <div class="icon-wrapper"><i data-lucide="book-open"></i></div>
                    <div class="stat-info">
                        <span id="stat-total-ebooks">...</span>
                        <p>Total de E-books</p>
                    </div>
                </div>
                <div class="stat-card reports">
                    <div class="icon-wrapper"><i data-lucide="alert-octagon"></i></div>
                    <div class="stat-info">
                        <span id="stat-total-reports">...</span>
                        <p>Denúncias Pendentes</p>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <h3>Distribuição de Conteúdo</h3>
                <div class="chart-container">
                    <div class="donut-chart" id="content-distribution-chart"></div>
                    <ul class="chart-legend" id="content-distribution-legend">
                        <li class="articles">
                            <span class="legend-dot dot-articles"></span>
                            <span class="legend-label">Artigos</span>
                            <span class="legend-value" id="chart-value-articles">...</span>
                        </li>
                        <li class="ebooks">
                            <span class="legend-dot dot-ebooks"></span>
                            <span class="legend-label">E-books</span>
                            <span class="legend-value" id="chart-value-ebooks">...</span>
                        </li>
                        <li class="topics">
                            <span class="legend-dot dot-topics"></span>
                            <span class="legend-label">Tópicos do Fórum</span>
                            <span class="legend-value" id="chart-value-topics">...</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="admin-card" style="margin-top: 30px;">
                <h3>Métricas Detalhadas</h3>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <i data-lucide="message-square"></i>
                        <span id="stat-total-comments">...</span>
                        <p>Total de Comentários</p>
                    </div>
                    <div class="metric-item">
                        <i data-lucide="send"></i>
                        <span id="stat-total-messages">...</span>
                        <p>Total de Mensagens</p>
                    </div>
                    <div class="metric-item">
                        <i data-lucide="user-plus"></i>
                        <span id="stat-new-users-today">...</span>
                        <p>Novos Usuários (Hoje)</p>
                    </div>
                    <div class="metric-item">
                        <i data-lucide="users"></i>
                        <span id="stat-total-friendships">...</span>
                        <p>Total de Amizades</p>
                    </div>
                </div>
            </div>
            
            <div class="admin-card" style="margin-top: 30px;">
                <h3>Crescimento (Últimos 7 dias)</h3>
                <div class="bar-chart-container" id="weekly-growth-chart">
                    <div class="bar-chart-item">
                        <div class="bar-label">Novos Usuários</div>
                        <div class="bar-wrapper">
                            <div class="bar" id="stat-bar-users" style="--bar-value: 0;"></div>
                        </div>
                        <div class="bar-value" id="stat-value-users">0</div>
                    </div>
                    <div class="bar-chart-item">
                        <div class="bar-label">Novos Artigos</div>
                        <div class="bar-wrapper">
                            <div class="bar" id="stat-bar-articles" style="--bar-value: 0;"></div>
                        </div>
                        <div class="bar-value" id="stat-value-articles">0</div>
                    </div>
                    <div class="bar-chart-item">
                        <div class="bar-label">Novos E-books</div>
                        <div class="bar-wrapper">
                            <div class="bar" id="stat-bar-ebooks" style="--bar-value: 0;"></div>
                        </div>
                        <div class="bar-value" id="stat-value-ebooks">0</div>
                    </div>
                </div>
            </div>

        </div>
        <div id="usuarios-panel" class="admin-panel">
            <div class="admin-header">
                <h1>Gerenciamento de Usuários</h1>
                <div class="admin-search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" id="user-search-bar" placeholder="Buscar por nome ou e-mail...">
                </div>
            </div>
            <div class="admin-card">
                <table class="data-table" id="users-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Nome de Exibição</th>
                            <th>E-mail</th>
                            <th>Admin?</th>
                            <th>ID do Usuário</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align: center; padding: 20px;">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="artigos-panel" class="admin-panel">
            <div class="admin-header">
                <h1>Gerenciamento de Artigos</h1>
                <div class="admin-search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" id="article-search-bar" placeholder="Buscar por título...">
                </div>
            </div>
            <div class="admin-card">
                <table class="data-table" id="articles-table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Autor</th>
                            <th>Likes</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" style="text-align: center; padding: 20px;">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="ebooks-panel" class="admin-panel">
             <div class="admin-header">
                <h1>Gerenciamento de E-books</h1>
                <div class="admin-search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" id="ebook-search-bar" placeholder="Buscar por título...">
                </div>
            </div>
            <div class="admin-card">
                <table class="data-table" id="ebooks-table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Autor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" style="text-align: center; padding: 20px;">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="forum-panel" class="admin-panel">
             <div class="admin-header">
                <h1>Gerenciamento de Tópicos</h1>
                <div class="admin-search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" id="topic-search-bar" placeholder="Buscar por título...">
                </div>
            </div>
            <div class="admin-card">
                <table class="data-table" id="topics-table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Link</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" style="text-align: center; padding: 20px;">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="denuncias-panel" class="admin-panel">
             <div class="admin-header">
                <h1>Gerenciamento de Denúncias</h1>
                <div class="admin-search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" id="report-search-bar" placeholder="Buscar por motivo ou tipo...">
                </div>
            </div>
            <div class="admin-card">
                <table class="data-table" id="reports-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Data</th>
                            <th>Denunciante</th>
                            <th>Conteúdo</th>
                            <th>Motivo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align: center; padding: 20px;">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="arquivo-panel" class="admin-panel">
            <div class="admin-header">
                <h1>Arquivo de Resultados</h1>
            </div>
            
            <div class="archive-layout">
                <aside class="archive-menu" id="archive-menu-container">
                    <h3>Navegar por Data</h3>
                    <div id="archive-menu-content">
                        <p>Carregando histórico...</p>
                    </div>
                </aside>
                
                <section class="archive-results">
                    <div class="admin-card">
                        <div id="archive-results-content">
                            <p style="text-align: center; padding: 40px 0; color: var(--text-light);">
                                <i data-lucide="archive" style="width: 48px; height: 48px; margin-bottom: 10px;"></i><br>
                                Selecione um mês no menu ao lado para ver os dados.
                            </p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        
    </main>

    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-modal-btn" class="modal-close" aria-label="Fechar modal"><i data-lucide="x"></i></button>
            <h2>Detalhes do Usuário</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label for="edit-full-name">Nome de Exibição</label>
                    <input type="text" id="edit-full-name">
                </div>
                <div class="form-group">
                    <label for="edit-email">E-mail</label>
                    <input type="email" id="edit-email" disabled>
                </div>
                 <div class="form-group form-group-check">
                    <input type="checkbox" id="edit-is-admin" style="width: 20px; height: 20px;">
                    <label for="edit-is-admin" style="margin: 0; font-weight: bold;">Tornar Administrador?</label>
                </div>

                <div class="modal-user-content">
                    <h3>Conteúdo Criado</h3>
                    
                    <label style="font-weight: 600; font-size: 0.9em; margin-bottom: 5px;">Artigos:</label>
                    <div class="user-content-list" id="modal-user-articles">
                        <p>Carregando...</p>
                    </div>

                    <label style="font-weight: 600; font-size: 0.9em; margin-top: 15px; margin-bottom: 5px;">E-books:</label>
                    <div class="user-content-list" id="modal-user-ebooks">
                        <p>Carregando...</p>
                    </div>

                    <label style="font-weight: 600; font-size: 0.9em; margin-top: 15px; margin-bottom: 5px;">Tópicos do Fórum:</label>
                    <div class="user-content-list" id="modal-user-topics">
                        <p>Carregando...</p>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-edit-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        const { createClient } = supabase;
        const SUPABASE_URL = 'https://iuyapkycjgmyvxlpycdd.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1eWFwa3ljamdteXZ4bHB5Y2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMTYwODUsImV4cCI6MjA3NjY5MjA4NX0.VlLOoSnNvaWoMFtof6zaLUgWC60bCBJT_ckdI7GRFkM';
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let presenceChannel = null; 
        let onlineUsers = new Set(); 
        let allProfilesCache = []; 
        
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        // [NOVO] Cache para os dados do arquivo (evita refazer o client-side)
        let archiveDataCache = null; 

        function formatTimeAgo(dateString) {
            if (!dateString) return 'Offline';
            const date = new Date(dateString);
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return `visto há ${Math.floor(interval)} anos`;
            interval = seconds / 2592000;
            if (interval > 1) return `visto há ${Math.floor(interval)} meses`;
            interval = seconds / 86400;
            if (interval > 1) return `visto há ${Math.floor(interval)} dias`;
            interval = seconds / 3600;
            if (interval > 1) return `visto há ${Math.floor(interval)} horas`;
            interval = seconds / 60;
            if (interval > 1) return `visto há ${Math.floor(interval)} min`;
            return "visto agora";
        }
        
        async function updateReportsBadge() {
            const reportsBadge = document.getElementById('reports-badge');
            if (!reportsBadge) return;
            
            const { count, error } = await sb.from('reports')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'new');
                
            if (!error && count > 0) {
                reportsBadge.textContent = count;
                reportsBadge.classList.add('visible');
            } else {
                reportsBadge.classList.remove('visible');
            }
        }

        // --- 1. VERIFICAÇÃO DE SEGURANÇA ---
        async function checkAdminAuth() {
            const { data: { session }, error: sessionError } = await sb.auth.getSession();
            if (sessionError || !session) {
                window.location.href = 'login.html';
                return null;
            }
            
            const { data: profile, error: profileError } = await sb.from('profiles')
                .select('is_admin, full_name, avatar_url')
                .eq('id', session.user.id)
                .single();

            if (profileError || !profile || !profile.is_admin) {
                console.error('Falha na verificação de admin:', profileError || 'Usuário não é admin');
                alert('Acesso negado. Esta página é restrita para administradores.');
                window.location.href = 'index.html';
                return null;
            }
            return session.user;
        }

        // --- 2. LÓGICA DE NAVEGAÇÃO DO PAINEL ---
        const tabLinks = document.querySelectorAll('.nav-tab');
        const tabPanels = document.querySelectorAll('.admin-panel');
        const logoutBtn = document.getElementById('logout-btn');

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const panelId = link.getAttribute('href').substring(1) + '-panel';
                
                tabLinks.forEach(l => l.classList.remove('active'));
                tabPanels.forEach(p => p.classList.remove('active'));
                
                link.classList.add('active');
                const activePanel = document.getElementById(panelId);
                if (activePanel) {
                    activePanel.classList.add('active');
                    loadDataForPanel(panelId); 
                }
            });
        });
        
        logoutBtn.addEventListener('click', async () => {
             if (presenceChannel) {
                 await presenceChannel.untrack(); // Avisa que o admin saiu
                 await presenceChannel.unsubscribe();
             }
             await sb.auth.signOut();
             window.location.href = 'index.html';
        });

        // --- 3. CARREGAMENTO E RENDERIZAÇÃO DE DADOS ---
        
        async function loadDataForPanel(panelId) {
            switch(panelId) {
                case 'dashboard-panel':
                    await loadDashboardStats();
                    break;
                case 'usuarios-panel':
                    await loadUsers();
                    break;
                case 'artigos-panel':
                    await loadArticles();
                    break;
                case 'ebooks-panel':
                    await loadEbooks();
                    break;
                case 'forum-panel':
                    await loadTopics();
                    break;
                case 'denuncias-panel':
                    await loadReports();
                    break;
                case 'arquivo-panel':
                    await loadArchiveMenu();
                    break;
            }
        }

        // Função de Analytics atualizada com Gráfico Semanal
        async function loadDashboardStats() {
            
            // IDs dos Cards Principais
            const userStatEl = document.getElementById('stat-total-users');
            const activeUserStatEl = document.getElementById('stat-active-users');
            const articleStatEl = document.getElementById('stat-total-articles');
            const ebookStatEl = document.getElementById('stat-total-ebooks');
            const reportStatEl = document.getElementById('stat-total-reports');
            
            // IDs do Gráfico Donut
            const donutChart = document.getElementById('content-distribution-chart');
            const legendArticles = document.getElementById('chart-value-articles');
            const legendEbooks = document.getElementById('chart-value-ebooks');
            const legendTopics = document.getElementById('chart-value-topics');

            // IDs das Métricas Detalhadas
            const commentsStatEl = document.getElementById('stat-total-comments');
            const messagesStatEl = document.getElementById('stat-total-messages');
            const newUsersStatEl = document.getElementById('stat-new-users-today');
            const friendsStatEl = document.getElementById('stat-total-friendships');

            // IDs do Gráfico de Barras
            const statBarUsers = document.getElementById('stat-bar-users');
            const statValueUsers = document.getElementById('stat-value-users');
            const statBarArticles = document.getElementById('stat-bar-articles');
            const statValueArticles = document.getElementById('stat-value-articles');
            const statBarEbooks = document.getElementById('stat-bar-ebooks');
            const statValueEbooks = document.getElementById('stat-value-ebooks');

            // Coloca "..." em todos enquanto carrega
            [userStatEl, activeUserStatEl, articleStatEl, ebookStatEl, reportStatEl, 
             legendArticles, legendEbooks, legendTopics, commentsStatEl, messagesStatEl, 
             newUsersStatEl, friendsStatEl, statValueUsers, statValueArticles, statValueEbooks
            ].forEach(el => {
                if (el) el.textContent = '...';
            });
             
            // Define o início do dia de hoje (para o filtro "Novos Usuários")
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayISO = today.toISOString();
            
            // Define data de 7 dias atrás
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            sevenDaysAgo.setHours(0, 0, 0, 0);
            const sevenDaysAgoISO = sevenDaysAgo.toISOString();

            try {
                // Adicionamos mais queries ao Promise.all
                const [
                    { count: userCount, error: userError },
                    { count: articleCount, error: articleError },
                    { count: ebookCount, error: ebookError },
                    { count: reportCount, error: reportError },
                    { count: topicCount, error: topicError },
                    { count: commentCount, error: commentError },
                    { count: messageCount, error: messageError },
                    { count: newUsersTodayCount, error: newUsersError }, // Renomeado
                    { count: friendshipCount, error: friendshipError },
                    
                    // 3 Queries para o Gráfico de Barras
                    { count: newUsersWeekCount, error: newUsersWeekError },
                    { count: newArticlesWeekCount, error: newArticlesWeekError },
                    { count: newEbooksWeekCount, error: newEbooksWeekError }

                ] = await Promise.all([
                    sb.from('profiles').select('*', { count: 'exact', head: true }),
                    sb.from('community-articles').select('*', { count: 'exact', head: true }),
                    sb.from('ebooks').select('*', { count: 'exact', head: true }),
                    sb.from('reports').select('*', { count: 'exact', head: true }).eq('status', 'new'),
                    sb.from('forum_topics').select('*', { count: 'exact', head: true }),
                    // Novas queries:
                    sb.from('comments').select('*', { count: 'exact', head: true }),
                    sb.from('messages').select('*', { count: 'exact', head: true }),
                    sb.from('profiles').select('*', { count: 'exact', head: true }).gte('created_at', todayISO),
                    sb.from('friendships').select('*', { count: 'exact', head: true }).eq('status', 'accepted'),
                    
                    // 3 Queries para o Gráfico de Barras
                    sb.from('profiles').select('*', { count: 'exact', head: true }).gte('created_at', sevenDaysAgoISO),
                    sb.from('community-articles').select('*', { count: 'exact', head: true }).gte('created_at', sevenDaysAgoISO),
                    sb.from('ebooks').select('*', { count: 'exact', head: true }).gte('created_at', sevenDaysAgoISO)
                ]);
                
                // Tratamento de erros
                if (userError) console.error("Erro ao contar usuários:", userError.message);
                if (articleError) console.error("Erro ao contar artigos:", articleError.message);
                
                // 1. Atualiza os Stat Cards
                userStatEl.textContent = userCount ?? 0;
                articleStatEl.textContent = articleCount ?? 0;
                ebookStatEl.textContent = ebookCount ?? 0;
                reportStatEl.textContent = reportCount ?? 0;
                
                // 2. Atualiza as Novas Métricas
                commentsStatEl.textContent = commentCount ?? 0;
                messagesStatEl.textContent = messageCount ?? 0;
                newUsersStatEl.textContent = newUsersTodayCount ?? 0;
                friendsStatEl.textContent = friendshipCount ?? 0;

                // 3. Atualiza o Gráfico Donut
                const ac = articleCount || 0;
                const ec = ebookCount || 0;
                const tc = topicCount || 0;
                const totalContent = ac + ec + tc;
                const safeTotal = totalContent === 0 ? 1 : totalContent; 
                
                const articlePercent = (ac / safeTotal) * 100;
                const ebookPercent = (ec / safeTotal) * 100;
                const topicPercent = (tc / safeTotal) * 100;

                if (donutChart) {
                    setTimeout(() => {
                        donutChart.style.setProperty('--p-articles', articlePercent);
                        donutChart.style.setProperty('--p-ebooks', ebookPercent);
                        donutChart.style.setProperty('--p-topics', topicPercent);
                    }, 100);
                }
                legendArticles.textContent = `${ac} (${articlePercent.toFixed(0)}%)`;
                legendEbooks.textContent = `${ec} (${ebookPercent.toFixed(0)}%)`;
                legendTopics.textContent = `${tc} (${topicPercent.toFixed(0)}%)`;

                // 4. Atualiza o Gráfico de Barras
                const usersWeek = newUsersWeekCount ?? 0;
                const articlesWeek = newArticlesWeekCount ?? 0;
                const ebooksWeek = newEbooksWeekCount ?? 0;
                
                statValueUsers.textContent = usersWeek;
                statValueArticles.textContent = articlesWeek;
                statValueEbooks.textContent = ebooksWeek;
                
                // Achar o valor máximo para a escala (mínimo de 10 para ter visual)
                const maxGrowth = Math.max(usersWeek, articlesWeek, ebooksWeek, 10); 
                
                if (statBarUsers) {
                    setTimeout(() => {
                        statBarUsers.style.setProperty('--bar-value', (usersWeek / maxGrowth) * 100);
                        statBarArticles.style.setProperty('--bar-value', (articlesWeek / maxGrowth) * 100);
                        statBarEbooks.style.setProperty('--bar-value', (ebooksWeek / maxGrowth) * 100);
                    }, 100);
                }
                
            } catch (error) {
                console.error("Erro geral ao buscar estatísticas:", error);
                userStatEl.textContent = 'Erro';
            }

            // Adiciona a renderização dos ícones das novas métricas
            lucide.createIcons();
        }

        // USUÁRIOS
        async function loadUsers() {
            const tableBody = document.querySelector('#users-table tbody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Carregando...</td></tr>';
            
            const searchTerm = document.getElementById('user-search-bar').value.trim();
            
            let query = sb.from('profiles').select('*');

            if (searchTerm) {
                query = query.or(`full_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
            }
            
            const { data: users, error } = await query;
            
            if (error) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--danger-color);">Erro ao carregar: ${error.message}</td></tr>`;
                return;
            }
            
            allProfilesCache = users; 
            renderUsers(users);
            renderUserStatus(); 
            lucide.createIcons();
        }
        
        function renderUsers(users) {
            const tableBody = document.querySelector('#users-table tbody');
            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Nenhum usuário encontrado.</td></tr>';
                return;
            }
            tableBody.innerHTML = users.map(user => `
                <tr data-user-id="${user.id}">
                    <td class="status-cell">
                        <span class="status-dot offline"></span>
                        <span class="status-text" data-user-id="${user.id}">${formatTimeAgo(user.last_seen)}</span>
                    </td>
                    <td>${user.full_name || '<i>Não definido</i>'}</td>
                    <td>${user.email || '<i>null</i>'}</td>
                    <td>${user.is_admin ? 'Sim' : 'Não'}</td>
                    <td><code style="font-size: 0.9em;">${user.id}</code></td>
                    <td class="actions">
                        <button class="btn-icon btn-edit edit-user-btn" data-id="${user.id}"><i data-lucide="edit-2"></i></button>
                        <button class="btn-icon btn-delete delete-user-btn" data-id="${user.id}"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Função setupPresence corrigida (da última alteração)
        async function setupPresence() {
            const activeUserStatEl = document.getElementById('stat-active-users');
            if (activeUserStatEl) activeUserStatEl.textContent = '0'; // Valor inicial
            
            presenceChannel = sb.channel('user-presence');

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    onlineUsers.clear();
                    const newState = presenceChannel.presenceState();
                    for (const id in newState) {
                        newState[id].forEach(presence => {
                            onlineUsers.add(presence.user_id);
                        });
                    }
                    if (activeUserStatEl) activeUserStatEl.textContent = onlineUsers.size; 
                    renderUserStatus(); 
                })
                .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                    newPresences.forEach(p => onlineUsers.add(p.user_id));
                    if (activeUserStatEl) activeUserStatEl.textContent = onlineUsers.size; 
                    renderUserStatus();
                })
                .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                    leftPresences.forEach(p => onlineUsers.delete(p.user_id));
                    if (activeUserStatEl) activeUserStatEl.textContent = onlineUsers.size; 
                    renderUserStatus(); 
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await presenceChannel.track({ 
                            user_id: currentUser.id, // currentUser é definido na função init()
                            online_at: new Date().toISOString() 
                        });
                    }
                });
        }

        function renderUserStatus() {
            const statusCells = document.querySelectorAll('.status-text');
            statusCells.forEach(cell => {
                const userId = cell.dataset.userId;
                const dot = cell.previousElementSibling; 
                
                if (onlineUsers.has(userId)) {
                    cell.textContent = 'Online';
                    cell.className = 'status-text online';
                    dot.className = 'status-dot online';
                } else {
                    const profile = allProfilesCache.find(p => p.id === userId);
                    cell.textContent = formatTimeAgo(profile?.last_seen);
                    cell.className = 'status-text';
                    dot.className = 'status-dot offline';
                }
            });
        }
        
        // ARTIGOS
        async function loadArticles() {
            const tableBody = document.querySelector('#articles-table tbody');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Carregando...</td></tr>';
            
            const searchTerm = document.getElementById('article-search-bar').value.trim();
            let query = sb.from('community-articles').select('*');
            
            if (searchTerm) {
                query = query.ilike('title', `%${searchTerm}%`);
            }
            
            const { data: articles, error } = await query;
            if (error) { tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--danger-color);">Erro ao carregar: ${error.message}</td></tr>`; return; }
            renderArticles(articles);
            lucide.createIcons();
        }
        function renderArticles(articles) {
            const tableBody = document.querySelector('#articles-table tbody');
            if (articles.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Nenhum artigo encontrado.</td></tr>'; return; }
            tableBody.innerHTML = articles.map(article => `
                <tr>
                    <td>${article.title}</td>
                    <td>${article.author_name || '<i>Não definido</i>'}</td>
                    <td>${article.likes || 0}</td>
                    <td class="actions">
                        <a href="comunidade.html?article=${article.id}" target="_blank" class="btn-icon btn-edit" title="Ver Artigo"><i data-lucide="eye"></i></a>
                        <button class="btn-icon btn-delete delete-article-btn" data-id="${article.id}"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        // E-BOOKS
        async function loadEbooks() {
            const tableBody = document.querySelector('#ebooks-table tbody');
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Carregando...</td></tr>';
            
            const searchTerm = document.getElementById('ebook-search-bar').value.trim();
            let query = sb.from('ebooks').select('*');
            
            if (searchTerm) {
                query = query.ilike('title', `%${searchTerm}%`);
            }

            const { data: ebooks, error } = await query;
            if (error) { tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--danger-color);">Erro ao carregar: ${error.message}</td></tr>`; return; }
            renderEbooks(ebooks);
            lucide.createIcons();
        }
        function renderEbooks(ebooks) {
            const tableBody = document.querySelector('#ebooks-table tbody');
             if (ebooks.length === 0) { tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Nenhum e-book encontrado.</td></tr>'; return; }
            tableBody.innerHTML = ebooks.map(ebook => `
                <tr>
                    <td>${ebook.title}</td>
                    <td>${ebook.author_name || '<i>Não definido</i>'}</td>
                    <td class="actions">
                        <a href="${ebook.pdf_url}" target="_blank" class="btn-icon btn-edit" title="Ver PDF"><i data-lucide="eye"></i></a>
                        <button class="btn-icon btn-delete delete-ebook-btn" data-id="${ebook.id}"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        // TÓPICOS DO FÓRUM
        async function loadTopics() {
            const tableBody = document.querySelector('#topics-table tbody');
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Carregando...</td></tr>';
            
            const searchTerm = document.getElementById('topic-search-bar').value.trim();
            let query = sb.from('forum_topics').select('*');

            if (searchTerm) {
                query = query.ilike('title', `%${searchTerm}%`);
            }
            
            const { data: topics, error } = await query;
            if (error) { tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--danger-color);">Erro ao carregar: ${error.message}</td></tr>`; return; }
            renderTopics(topics);
            lucide.createIcons();
        }
        function renderTopics(topics) {
            const tableBody = document.querySelector('#topics-table tbody');
             if (topics.length === 0) { tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Nenhum tópico encontrado.</td></tr>'; return; }
            tableBody.innerHTML = topics.map(topic => `
                <tr>
                    <td>${topic.title}</td>
                    <td><a href="${topic.whatsapp_link}" target="_blank">Link do Grupo</a></td>
                    <td class="actions">
                        <button class="btn-icon btn-delete delete-topic-btn" data-id="${topic.id}"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        // DENÚNCIAS
        async function loadReports() {
            const tableBody = document.querySelector('#reports-table tbody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Carregando...</td></tr>';
            
            const searchTerm = document.getElementById('report-search-bar').value.trim();
            let query = sb.from('reports')
                          .select('*, reporter:profiles(full_name, email)')
                          .order('created_at', { ascending: false });

            if (searchTerm) {
                query = query.or(`reason.ilike.%${searchTerm}%,content_type.ilike.%${searchTerm}%`);
            }
            
            const { data: reports, error } = await query;
            
            if (error) { 
                console.error(error);
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--danger-color);">Erro ao carregar: ${error.message}</td></tr>`; 
                return; 
            }
            renderReports(reports);
            updateReportsBadge();
            lucide.createIcons();
        }
        
        // renderReports agora inclui o novo botão
        function renderReports(reports) {
            const tableBody = document.querySelector('#reports-table tbody');
             if (reports.length === 0) { 
                 tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Nenhuma denúncia encontrada.</td></tr>'; 
                 return; 
             }
            tableBody.innerHTML = reports.map(report => {
                const reporterName = report.reporter?.full_name || report.reporter?.email || '<i>Usuário deletado</i>';
                
                // Lógica do botão de exclusão de conteúdo
                let deleteContentBtnHtml = '';
                if (report.content_type === 'article' || report.content_type === 'ebook' || report.content_type === 'topic' || report.content_type === 'comment') {
                    deleteContentBtnHtml = `
                        <button class="btn-icon btn-delete delete-reported-content-btn" 
                                data-id="${report.content_id}" 
                                data-type="${report.content_type}" 
                                title="Excluir Conteúdo Reportado (${report.content_type})">
                            <i data-lucide="shield-x"></i>
                        </button>
                    `;
                }
                
                return `
                <tr data-report-id="${report.id}">
                    <td><span class="report-status-badge ${report.status}">${report.status}</span></td>
                    <td>${new Date(report.created_at).toLocaleDateString()}</td>
                    <td>${reporterName}</td>
                    <td>
                        <a href="${report.content_link || '#'}" target="_blank" class="btn-icon btn-edit" title="Ver conteúdo">
                            <i data-lucide="eye"></i> ${report.content_type}
                        </a>
                    </td>
                    <td class="report-reason-cell">${report.reason}</td>
                    <td class="actions">
                        ${report.status === 'new' ? 
                            `<button class="btn-icon btn-resolve resolve-report-btn" data-id="${report.id}" title="Marcar como Resolvido"><i data-lucide="check-check"></i></button>` : 
                            ''
                        }
                        ${deleteContentBtnHtml}
                        
                        <button class="btn-icon btn-delete delete-report-btn" data-id="${report.id}" title="Excluir denúncia (manter conteúdo)"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
        
        async function loadUserContent(userId) {
            const articlesList = document.getElementById('modal-user-articles');
            const ebooksList = document.getElementById('modal-user-ebooks');
            const topicsList = document.getElementById('modal-user-topics');

            articlesList.innerHTML = "<p>Carregando...</p>";
            ebooksList.innerHTML = "<p>Carregando...</p>";
            topicsList.innerHTML = "<p>Carregando...</p>";

            // Carrega Artigos
            const { data: articles, error: articlesError } = await sb.from('community-articles')
                .select('id, title')
                .eq('author_id', userId);
            if (articles && articles.length > 0) {
                articlesList.innerHTML = articles.map(a => `<a href="comunidade.html?article=${a.id}" target="_blank" class="user-content-list-item">${a.title}</a>`).join('');
            } else {
                articlesList.innerHTML = "<p>Nenhum artigo criado.</p>";
            }

            // Carrega E-books
            const { data: ebooks, error: ebooksError } = await sb.from('ebooks')
                .select('id, title, pdf_url')
                .eq('author_id', userId);
            if (ebooks && ebooks.length > 0) {
                ebooksList.innerHTML = ebooks.map(e => `<a href="${e.pdf_url}" target="_blank" class="user-content-list-item">${e.title}</a>`).join('');
            } else {
                ebooksList.innerHTML = "<p>Nenhum e-book criado.</p>";
            }
            
            // Carrega Tópicos do Fórum
            const { data: topics, error: topicsError } = await sb.from('forum_topics')
                .select('id, title, whatsapp_link')
                .eq('created_by', userId);
            if (topics && topics.length > 0) {
                topicsList.innerHTML = topics.map(t => `<a href="${t.whatsapp_link}" target="_blank" class="user-content-list-item">${t.title}</a>`).join('');
            } else {
                topicsList.innerHTML = "<p>Nenhum tópico criado.</p>";
            }
        }
        
        // --- 4. LÓGICA DE AÇÕES (DELETAR, EDITAR) ---
        
        // Funções de exclusão refatoradas
        
        async function handleDeleteArticle(articleId) {
            if (confirm('Tem certeza que quer excluir este artigo? Esta ação é permanente e também deletará os arquivos do armazenamento.')) {
                try {
                    const { data: article, error: fetchError } = await sb.from('community-articles')
                        .select('pdfUrl, cover_image_url')
                        .eq('id', articleId)
                        .single();

                    if (fetchError) {
                        alert(`Erro ao buscar dados do artigo: ${fetchError.message}\nO registro do banco será deletado mesmo assim.`);
                    }

                    if (article) {
                        let filesToDelete = [];
                        if (article.pdfUrl) {
                            try {
                                const pdfPath = new URL(article.pdfUrl).pathname.split('/community-articles/')[1];
                                if(pdfPath) filesToDelete.push(pdfPath);
                            } catch(e) { console.warn('URL do PDF inválida', e); }
                        }
                        if (article.cover_image_url) {
                            try {
                                const coverPath = new URL(article.cover_image_url).pathname.split('/community-articles/')[1];
                                if(coverPath) filesToDelete.push(coverPath);
                            } catch(e) { console.warn('URL da Capa inválida', e); }
                        }

                        if (filesToDelete.length > 0) {
                            const { error: storageError } = await sb.storage.from('community-articles').remove(filesToDelete);
                            if (storageError && storageError.message !== 'The resource was not found') {
                                alert(`Aviso: Erro ao deletar arquivos do storage: ${storageError.message}. O registro do banco será deletado mesmo assim.`);
                            }
                        }
                    }

                    const { error: dbError } = await sb.from('community-articles').delete().eq('id', articleId);
                    if (dbError) throw dbError;

                    alert('Artigo deletado com sucesso.');
                    // Realtime fará a atualização

                } catch (error) {
                    console.error("Erro no processo de exclusão de artigo:", error);
                    alert(`Erro ao excluir: ${error.message}`);
                }
            }
        }
        
        async function handleDeleteEbook(ebookId) {
            if (confirm('Tem certeza que quer excluir este e-book? Esta ação é permanente e também deletará os arquivos do armazenamento.')) {
                try {
                    const { data: ebook, error: fetchError } = await sb.from('ebooks')
                        .select('pdf_url, cover_image_url')
                        .eq('id', ebookId)
                        .single();

                    if (fetchError) {
                        alert(`Erro ao buscar dados do e-book: ${fetchError.message}\nO registro do banco será deletado mesmo assim.`);
                    }

                    if (ebook) {
                        let filesToDelete = [];
                        if (ebook.pdf_url) {
                            try {
                                const pdfPath = new URL(ebook.pdf_url).pathname.split('/ebooks/')[1];
                                if(pdfPath) filesToDelete.push(pdfPath);
                            } catch(e) { console.warn('URL do PDF inválida', e); }
                        }
                        if (ebook.cover_image_url) {
                            try {
                                const coverPath = new URL(ebook.cover_image_url).pathname.split('/ebooks/')[1];
                                if(coverPath) filesToDelete.push(coverPath);
                            } catch(e) { console.warn('URL da Capa inválida', e); }
                        }

                        if (filesToDelete.length > 0) {
                            const { error: storageError } = await sb.storage.from('ebooks').remove(filesToDelete);
                            if (storageError && storageError.message !== 'The resource was not found') {
                                alert(`Aviso: Erro ao deletar arquivos do storage: ${storageError.message}. O registro do banco será deletado mesmo assim.`);
                            }
                        }
                    }

                    const { error: dbError } = await sb.from('ebooks').delete().eq('id', ebookId);
                    if (dbError) throw dbError;
                    
                    alert('E-book deletado com sucesso.');
                    // Realtime fará a atualização

                } catch (error) {
                    console.error("Erro no processo de exclusão de e-book:", error);
                    alert(`Erro ao excluir: ${error.message}`);
                }
            }
        }
        
        async function handleDeleteTopic(topicId) {
             if (confirm('Tem certeza que quer excluir este tópico?')) {
                const { error } = await sb.from('forum_topics').delete().eq('id', topicId);
                if (error) alert(`Erro ao excluir: ${error.message}`);
                // Realtime fará a atualização
             }
        }
        
        async function handleDeleteComment(commentId) {
            if (confirm('Tem certeza que quer excluir este comentário?')) {
                const { error } = await sb.from('comments').delete().eq('id', commentId);
                if (error) {
                    alert(`Erro ao excluir comentário: ${error.message}`);
                } else {
                    alert('Comentário excluído com sucesso.');
                    // Realtime de 'reports' vai recarregar a lista
                }
            }
        }
        
        
        const editModal = document.getElementById('edit-user-modal');
        const editForm = document.getElementById('edit-user-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        document.body.addEventListener('click', async (e) => {
            const editUserBtn = e.target.closest('.edit-user-btn');
            const deleteUserBtn = e.target.closest('.delete-user-btn');
            const deleteArticleBtn = e.target.closest('.delete-article-btn');
            const deleteEbookBtn = e.target.closest('.delete-ebook-btn');
            const deleteTopicBtn = e.target.closest('.delete-topic-btn');
            const resolveReportBtn = e.target.closest('.resolve-report-btn'); 
            const deleteReportBtn = e.target.closest('.delete-report-btn');
            const deleteReportedContentBtn = e.target.closest('.delete-reported-content-btn');
            
            // Listeners para o Arquivo
            const archiveYearHeader = e.target.closest('.archive-year-header');
            const archiveMonthBtn = e.target.closest('.archive-month-btn');
            
            if (editUserBtn) {
                const userId = editUserBtn.dataset.id;
                const user = allProfilesCache.find(p => p.id === userId);
                if (user) {
                    editForm['edit-user-id'].value = user.id;
                    editForm['edit-full-name'].value = user.full_name || '';
                    editForm['edit-email'].value = user.email || '';
                    editForm['edit-is-admin'].checked = user.is_admin;
                    
                    loadUserContent(userId);
                    
                    editModal.classList.add('visible');
                }
            }
            
            else if (deleteUserBtn) {
                const userId = deleteUserBtn.dataset.id;
                const user = allProfilesCache.find(p => p.id === userId);
                const userName = user?.full_name || user?.email || userId;
                
                if (confirm(`TEM CERTEZA?\n\nVocê está prestes a DELETAR PERMANENTEMENTE o usuário:\n${userName}\n\nEsta ação não pode ser desfeita.`)) {
                    
                    try {
                        const { data, error } = await sb.functions.invoke('delete-user', {
                            body: { user_id_to_delete: userId }
                        });
                        
                        if (error) throw error; 
                        
                        alert('Usuário deletado com sucesso.');
                        loadUsers(); // Recarrega a lista de usuários
                        
                    } catch (error) {
                        console.error('Erro ao chamar Edge Function:', error);
                        
                        if (error.context && typeof error.context.json === 'function') {
                            const functionError = await error.context.json();
                            alert(`Erro ao deletar: ${functionError.error}`);
                        } else {
                            alert(`Erro ao deletar usuário: ${error.message}`);
                        }
                    }
                }
            }
            
            else if (deleteArticleBtn) {
                await handleDeleteArticle(deleteArticleBtn.dataset.id);
            }
            
            else if (deleteEbookBtn) {
                await handleDeleteEbook(deleteEbookBtn.dataset.id);
            }
            
            else if (deleteTopicBtn) {
                await handleDeleteTopic(deleteTopicBtn.dataset.id);
            }
            
            else if (resolveReportBtn) {
                const reportId = resolveReportBtn.dataset.id;
                if (confirm('Marcar esta denúncia como resolvida?')) {
                    const { error } = await sb.from('reports')
                        .update({ status: 'resolved' })
                        .eq('id', reportId);
                    if (error) alert(`Erro ao atualizar: ${error.message}`);
                    else loadReports(); 
                }
            }
            
            else if (deleteReportBtn) {
                const reportId = deleteReportBtn.dataset.id;
                if (confirm('Tem certeza que quer excluir esta denúncia? (Isso não exclui o conteúdo, apenas a denúncia)')) {
                    const { error } = await sb.from('reports')
                        .delete()
                        .eq('id', reportId);
                    if (error) alert(`Erro ao excluir: ${error.message}`);
                    else loadReports(); 
                }
            }
            
            else if (deleteReportedContentBtn) {
                const contentId = deleteReportedContentBtn.dataset.id;
                const contentType = deleteReportedContentBtn.dataset.type;

                if (confirm(`TEM CERTEZA?\n\nVocê está prestes a EXCLUIR PERMANENTEMENTE o CONTEÚDO reportado (tipo: ${contentType}).\n\nEsta ação não pode ser desfeita.`)) {
                    try {
                        switch (contentType) {
                            case 'article':
                                await handleDeleteArticle(contentId);
                                break;
                            case 'ebook':
                                await handleDeleteEbook(contentId);
                                break;
                            case 'topic':
                                await handleDeleteTopic(contentId);
                                break;
                            case 'comment':
                                await handleDeleteComment(contentId);
                                break;
                            default:
                                alert('Tipo de conteúdo desconhecido. Não é possível excluir.');
                        }
                        
                        // Após excluir o conteúdo, recarrega a lista de denúncias
                        await loadReports();

                    } catch (error) {
                        alert(`Erro ao excluir o conteúdo: ${error.message}`);
                    }
                }
            }
            
            else if (archiveYearHeader) {
                archiveYearHeader.parentElement.classList.toggle('open');
                lucide.createIcons();
            }
            
            else if (archiveMonthBtn) {
                document.querySelectorAll('.archive-month-btn.active').forEach(btn => btn.classList.remove('active'));
                archiveMonthBtn.classList.add('active');
                const year = archiveMonthBtn.dataset.year;
                const month = archiveMonthBtn.dataset.month;
                await loadMonthData(year, month);
            }
        });
        
        // Salvar Edição do Usuário
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = editForm['edit-user-id'].value;
            const fullName = editForm['edit-full-name'].value;
            const isAdmin = editForm['edit-is-admin'].checked;
            
            const { error } = await sb.from('profiles')
                .update({ full_name: fullName, is_admin: isAdmin })
                .eq('id', userId);
                
            if (error) {
                alert(`Erro ao salvar: ${error.message}`);
            } else {
                alert('Usuário atualizado com sucesso!');
                editModal.classList.remove('visible');
                loadUsers(); 
            }
        });
        
        cancelEditBtn.addEventListener('click', () => editModal.classList.remove('visible'));
        closeModalBtn.addEventListener('click', () => editModal.classList.remove('visible'));
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) editModal.classList.remove('visible');
        });

        // --- 5. LÓGICA DO ARQUIVO (CLIENT-SIDE) ---
        
        // [INÍCIO DA ALTERAÇÃO 2] Funções de Arquivo reescritas para usar JavaScript (Client-side)
        
        /** Busca e processa TODOS os dados de uma vez para o cache do arquivo */
        async function fetchAndBuildArchiveData() {
            const menuContainer = document.getElementById('archive-menu-content');
            menuContainer.innerHTML = "<p>Carregando histórico...</p>";
            
            try {
                // 1. Busca todos os 'created_at' de todas as tabelas
                const [
                    { data: articles, error: articlesError },
                    { data: ebooks, error: ebooksError },
                    { data: topics, error: topicsError }
                ] = await Promise.all([
                    sb.from('community-articles').select('created_at'),
                    sb.from('ebooks').select('created_at'),
                    sb.from('forum_topics').select('created_at')
                ]);

                if (articlesError || ebooksError || topicsError) {
                    throw new Error(articlesError?.message || ebooksError?.message || topicsError?.message);
                }

                // 2. Processa os dados no JavaScript (Client-Side)
                const allEntries = [
                    ...articles.map(a => ({ type: 'article', date: new Date(a.created_at) })),
                    ...ebooks.map(e => ({ type: 'ebook', date: new Date(e.created_at) })),
                    ...topics.map(t => ({ type: 'topic', date: new Date(t.created_at) }))
                ];

                // 3. Agrupa por Ano e Mês (para o menu)
                const summary = allEntries.reduce((acc, entry) => {
                    const year = entry.date.getFullYear();
                    const month = entry.date.getMonth() + 1; // 1-12
                    const key = `${year}-${month}`;

                    if (!acc[key]) {
                        acc[key] = {
                            year: year,
                            month: month,
                            article_count: 0,
                            ebook_count: 0,
                            topic_count: 0,
                        };
                    }
                    acc[key][`${entry.type}_count`]++;
                    
                    return acc;
                }, {});

                // [NOVA LÓGICA] Garante que o mês atual exista
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1; // 1-12
                const currentKey = `${currentYear}-${currentMonth}`;
                
                if (!summary[currentKey]) {
                    // Adiciona o mês atual com 0s se ele não tiver posts
                    summary[currentKey] = {
                        year: currentYear,
                        month: currentMonth,
                        article_count: 0,
                        ebook_count: 0,
                        topic_count: 0,
                    };
                }
                // [FIM DA NOVA LÓGICA]

                // 4. Agrupa por Dia (para a tabela detalhada)
                const dailyData = allEntries.reduce((acc, entry) => {
                    const year = entry.date.getFullYear();
                    const month = entry.date.getMonth() + 1; // 1-12
                    const day = entry.date.getDate(); // 1-31
                    const key = `${year}-${month}-${day}`;

                    if (!acc[key]) {
                        acc[key] = {
                            year: year,
                            month: month,
                            day: day,
                            article_count: 0,
                            ebook_count: 0,
                            topic_count: 0,
                        };
                    }
                    acc[key][`${entry.type}_count`]++;
                    return acc;
                }, {});

                // 5. Salva no cache
                archiveDataCache = {
                    summary: Object.values(summary).sort((a, b) => b.year - a.year || b.month - a.month),
                    daily: Object.values(dailyData)
                };
                
                return archiveDataCache;

            } catch (error) {
                console.error("Erro ao buscar resumo do arquivo:", error);
                menuContainer.innerHTML = `<p style="color: var(--danger-color);">Erro ao carregar menu.</p>`;
                return null;
            }
        }
        
        async function loadArchiveMenu() {
            // Se não tiver cache, busca os dados. Se tiver, usa o cache.
            const archiveData = archiveDataCache || await fetchAndBuildArchiveData();
            if (!archiveData) return;
            
            const menuContainer = document.getElementById('archive-menu-content');
            const summary = archiveData.summary;

            if (summary.length === 0) {
                menuContainer.innerHTML = "<p>Nenhum dado histórico encontrado.</p>";
                return;
            }
            
            // Agrupa os meses por ano
            const years = summary.reduce((acc, monthData) => {
                const { year, month, article_count, ebook_count, topic_count } = monthData;
                if (!acc[year]) {
                    acc[year] = [];
                }
                acc[year].push({ 
                    month: month, 
                    total: article_count + ebook_count + topic_count 
                });
                return acc;
            }, {});
            
            // Cria o HTML do menu
            let menuHtml = '';
            // Ordena os anos (do mais novo para o mais velho)
            const sortedYears = Object.keys(years).sort((a, b) => b - a);
            
            for (const year of sortedYears) {
                menuHtml += `
                    <div class="archive-year ${year == new Date().getFullYear() ? 'open' : ''}">
                        <div class="archive-year-header">
                            <span>${year}</span>
                            <i data-lucide="chevron-right"></i>
                        </div>
                        <ul class="archive-month-list">
                            ${years[year].map(month => `
                                <li>
                                    <button class="archive-month-btn" data-year="${year}" data-month="${month.month}">
                                        ${MONTH_NAMES[month.month - 1]}
                                        <span class="month-total">${month.total}</span>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            menuContainer.innerHTML = menuHtml;
            lucide.createIcons();
        }
        
        async function loadMonthData(year, month) {
            const resultsContainer = document.getElementById('archive-results-content');
            resultsContainer.innerHTML = `<p style="text-align: center; padding: 40px 0;">Carregando dados para ${MONTH_NAMES[month-1]} de ${year}...</p>`;
            
            // Pega os dados do cache
            const archiveData = archiveDataCache || await fetchAndBuildArchiveData();
            if (!archiveData) return;

            // Filtra os dados diários para o mês/ano selecionado
            const dailyDataForMonth = archiveData.daily.filter(d => d.year == year && d.month == month);

            // Gera todos os dias daquele mês (para preencher buracos)
            const daysInMonth = new Date(year, month, 0).getDate();
            let dailyDataMap = new Map();
            for (let i = 1; i <= daysInMonth; i++) {
                dailyDataMap.set(i, {
                    entry_day: i,
                    article_count: 0,
                    ebook_count: 0,
                    topic_count: 0
                });
            }
            // Preenche com os dados reais
            dailyDataForMonth.forEach(d => {
                dailyDataMap.set(d.day, {
                    entry_day: d.day,
                    article_count: d.article_count,
                    ebook_count: d.ebook_count,
                    topic_count: d.topic_count
                });
            });
            
            const dailyData = Array.from(dailyDataMap.values());
            
            // Processa os dados para o resumo
            let totalArticles = 0;
            let totalEbooks = 0;
            let totalTopics = 0;
            let maxDay = { day: 0, total: -1 };
            let minDay = { day: 0, total: Infinity };
            let noActivityDays = 0;
            
            dailyData.forEach(day => {
                const dayTotal = day.article_count + day.ebook_count + day.topic_count;
                totalArticles += day.article_count;
                totalEbooks += day.ebook_count;
                totalTopics += day.topic_count;
                
                if (dayTotal === 0) {
                    noActivityDays++;
                } else {
                    if (dayTotal > maxDay.total) {
                        maxDay = { day: day.entry_day, total: dayTotal };
                    }
                    // [CORREÇÃO] Só define o dia de menos atividade se for > 0
                    if (dayTotal < minDay.total && dayTotal > 0) { 
                        minDay = { day: day.entry_day, total: dayTotal };
                    }
                }
            });
            
            if (minDay.total === Infinity) minDay = { day: 0, total: 0 }; // Caso não tenha atividade
            
            // Gera o HTML do resultado
            let html = `
                <div class="archive-results-header">
                    <h2>${MONTH_NAMES[month-1]} de ${year}</h2>
                    <div class="archive-summary-grid">
                        <div class="archive-summary-item">
                            <span>${totalArticles}</span>
                            <p>Artigos</p>
                        </div>
                        <div class="archive-summary-item">
                            <span>${totalEbooks}</span>
                            <p>E-books</p>
                        </div>
                        <div class="archive-summary-item">
                            <span>${totalTopics}</span>
                            <p>Tópicos</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px; font-size: 0.9em; color: var(--text-light);">
                        <strong>Dia com mais atividade:</strong> Dia ${maxDay.day} (${maxDay.total} itens)<br>
                        <strong>Dia com menos atividade:</strong> Dia ${minDay.day} (${minDay.total} itens)<br>
                        <strong>Dias sem atividade:</strong> ${noActivityDays}
                    </div>
                </div>
                
                <table class="archive-daily-table">
                    <thead>
                        <tr>
                            <th>Dia</th>
                            <th>Artigos</th>
                            <th>E-books</th>
                            <th>Tópicos</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${dailyData.map(day => {
                            const total = day.article_count + day.ebook_count + day.topic_count;
                            let rowClass = '';
                            if (total === 0) rowClass = 'no-activity';
                            else if (total === maxDay.total && total > 0) rowClass = 'highlight-max';
                            else if (total === minDay.total && total > 0) rowClass = 'highlight-min';
                            
                            return `
                                <tr class="${rowClass}">
                                    <td class="day-cell">${day.entry_day}</td>
                                    <td>${day.article_count}</td>
                                    <td>${day.ebook_count}</td>
                                    <td>${day.topic_count}</td>
                                    <td>${total}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            resultsContainer.innerHTML = html;
        }
        
        // [FIM DA ALTERAÇÃO 2]

        // --- 6. INICIALIZAÇÃO E REALTIME ---
        async function init() {
            currentUser = await checkAdminAuth(); 
            if (currentUser) {
                loadDataForPanel('dashboard-panel'); 
                
                setupPresence(); 
                lucide.createIcons();
                updateReportsBadge(); 

                document.getElementById('user-search-bar').addEventListener('input', () => loadUsers());
                document.getElementById('article-search-bar').addEventListener('input', () => loadArticles());
                document.getElementById('ebook-search-bar').addEventListener('input', () => loadEbooks());
                document.getElementById('topic-search-bar').addEventListener('input', () => loadTopics());
                document.getElementById('report-search-bar').addEventListener('input', () => loadReports()); 
                
                // [INÍCIO DA ALTERAÇÃO 1] Adiciona os canais de Real-time
                sb.channel('public:reports')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'reports' }, 
                    (payload) => {
                        console.log('Mudança nas denúncias detectada!', payload);
                        updateReportsBadge(); 
                        
                        if(document.getElementById('dashboard-panel').classList.contains('active')) {
                            loadDashboardStats();
                        }
                        if(document.getElementById('denuncias-panel').classList.contains('active')) {
                            loadReports();
                        }
                    }
                  )
                  .subscribe();
                
                // Canal para Artigos
                sb.channel('public:community-articles')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'community-articles' }, 
                    (payload) => {
                        console.log('Mudança nos artigos detectada!', payload);
                        archiveDataCache = null; // Limpa o cache do arquivo
                        if(document.getElementById('dashboard-panel').classList.contains('active')) {
                            loadDashboardStats(); // Atualiza contagem no dashboard
                        }
                        if(document.getElementById('artigos-panel').classList.contains('active')) {
                            loadArticles(); // Atualiza a tabela de artigos se estiver aberta
                        }
                    }
                  )
                  .subscribe();

                // Canal para E-books
                sb.channel('public:ebooks')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'ebooks' }, 
                    (payload) => {
                        console.log('Mudança nos e-books detectada!', payload);
                        archiveDataCache = null; // Limpa o cache do arquivo
                        if(document.getElementById('dashboard-panel').classList.contains('active')) {
                            loadDashboardStats();
                        }
                        if(document.getElementById('ebooks-panel').classList.contains('active')) {
                            loadEbooks();
                        }
                    }
                  )
                  .subscribe();

                // Canal para Tópicos do Fórum
                sb.channel('public:forum_topics')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'forum_topics' }, 
                    (payload) => {
                        console.log('Mudança nos tópicos detectada!', payload);
                        archiveDataCache = null; // Limpa o cache do arquivo
                        if(document.getElementById('dashboard-panel').classList.contains('active')) {
                            loadDashboardStats();
                        }
                        if(document.getElementById('forum-panel').classList.contains('active')) {
                            loadTopics();
                        }
                    }
                  )
                  .subscribe();
                // [FIM DA ALTERAÇÃO 1]
            }
        }
        
        init();

    </script>
</body>
</html>